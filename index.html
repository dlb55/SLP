<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Found Discs</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <!-- Flatpickr CSS for date range picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        img.thumbnail { width: 50px; height: auto; object-fit: cover; }
        /* Make header filter inputs full-width */
        thead input { width: 100%; padding: 3px; box-sizing: border-box; }
        /* Hide footer since we're moving filters to header */
        tfoot { display: none; }
    </style>
</head>
<body>
    <h1>Shane's Found Disc Inventory</h1>
    <table id="discsTable" class="display">
        <thead>
            <tr>
                <th>Date Found</th>
                <th>Type</th>
                <th>Brand</th>
                <th>Mold</th>
                <th>Color</th>
                <th>Phone (Last 4 Digits)</th>
                <th>Image</th>
            </tr>
            <!-- Second row for filters, placed under headers but above data -->
            <tr class="filters">
                <th></th> <!-- Placeholder for Date Found filter (added via JS) -->
                <th></th> <!-- Type -->
                <th></th> <!-- Brand -->
                <th></th> <!-- Mold -->
                <th></th> <!-- Color -->
                <th></th> <!-- Phone -->
                <th></th> <!-- Image (no filter) -->
            </tr>
        </thead>
        <tbody></tbody>
        <!-- Footer is hidden, but kept for structure if needed later -->
        <tfoot>
            <tr>
                <th>Date Found</th>
                <th>Type</th>
                <th>Brand</th>
                <th>Mold</th>
                <th>Color</th>
                <th>Phone (Last 4 Digits)</th>
                <th>Image</th>
            </tr>
        </tfoot>
    </table>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <!-- Flatpickr JS for date range -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Actual published CSV URL
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQt7hOgFYgh4eWQaL8FhC-csrjn1qA0a-gwfn9PHGmjFu4VrjZuOD6-L_2Pu1AhjoJ-iKzyP9ka0r6Q/pub?gid=0&single=true&output=csv';

        async function fetchDiscs() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Failed to fetch CSV');
                const csvText = await response.text();

                // Parse CSV using PapaParse
                Papa.parse(csvText, {
                    header: false, // No headers in parsing; we'll skip first row manually
                    skipEmptyLines: true,
                    complete: function(results) {
                        const data = results.data;
                        if (data.length === 0) throw new Error('No data in CSV');

                        const tbody = document.querySelector('#discsTable tbody');
                        tbody.innerHTML = ''; // Clear existing rows

                        data.forEach((row, index) => {
                            if (index === 0) return; // Skip header row

                            const dateFound = row[0] || '';
                            const type = row[1] || '';
                            const brand = row[2] || '';
                            const mold = row[3] || '';
                            const color = row[4] || '';
                            const phone = row[5] || '';
                            const imageUrl = row[6] || '';

                            // Mask phone to last 4 digits
                            const maskedPhone = phone ? '****' + phone.slice(-4) : '';

                            // Create row
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${dateFound}</td>
                                <td>${type}</td>
                                <td>${brand}</td>
                                <td>${mold}</td>
                                <td>${color}</td>
                                <td>${maskedPhone}</td>
                                <td>${imageUrl ? `<img src="${imageUrl}" alt="Disc Image" class="thumbnail">` : 'No Image'}</td>
                            `;
                            tbody.appendChild(tr);
                        });

                        // Initialize DataTables after data is loaded
                        initDataTable();
                    },
                    error: function(error) {
                        console.error('PapaParse error:', error);
                        document.querySelector('#discsTable tbody').innerHTML = '<tr><td colspan="7">Error parsing data. Check console.</td></tr>';
                    }
                });
            } catch (error) {
                console.error('Error fetching data:', error);
                document.querySelector('#discsTable tbody').innerHTML = '<tr><td colspan="7">Error loading data. Check console.</td></tr>';
            }
        }

        function initDataTable() {
            // Custom date range filter for DataTables
            let minDate = null, maxDate = null;
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                const dateStr = data[0]; // Date Found column
                if (!dateStr) return true; // No date? Show it

                // Parse date assuming format like MM/DD/YYYY or YYYY-MM-DD (adjust parser if needed)
                const date = new Date(dateStr);
                if (isNaN(date)) return true; // Invalid date? Show it

                if ((minDate === null || date >= minDate) && (maxDate === null || date <= maxDate)) {
                    return true;
                }
                return false;
            });

            const table = $('#discsTable').DataTable({
                orderCellsTop: true, // Important for multi-row headers
                pageLength: 100, // Default to showing 100 entries
                lengthMenu: [10, 25, 50, 100, 'All'], // Options for the dropdown
                // Enable sorting on all columns except Image (index 6)
                columnDefs: [
                    { orderable: false, targets: 6 } // Disable sorting on Image
                ],
                // Add filters to the second header row
                initComplete: function () {
                    const api = this.api();
                    api.columns().every(function () {
                        const colIdx = this.index();
                        const column = this;
                        // Get the filter cell
                        const cell = $('.filters th').eq(colIdx);

                        // Skip filter for Image column (colIdx 6)
                        if (colIdx === 6) return;

                        cell.empty();
                        let input;
                        if (colIdx === 0) { // Date Found: Add Flatpickr range picker
                            input = $('<input type="text" placeholder="Select date range..."/>').appendTo(cell);
                            flatpickr(input[0], {
                                mode: "range",
                                dateFormat: "m/d/Y", // Assume MM/DD/YYYY; change to "Y-m-d" if YYYY-MM-DD in sheet
                                defaultDate: [], // Explicitly set no default date to start unfiltered
                                onChange: function(selectedDates) {
                                    minDate = selectedDates[0] ? selectedDates[0] : null;
                                    maxDate = selectedDates[1] ? selectedDates[1] : null;
                                    table.draw(); // Redraw table with custom filter
                                }
                            });
                        } else { // Text filters for other columns
                            input = $('<input type="text" placeholder="Filter..."/>').appendTo(cell);
                            input.on('keyup change clear', function () {
                                if (column.search() !== this.value) {
                                    column.search(this.value).draw();
                                }
                            });
                        }
                    });
                }
            });
        }

        // Load data on page load
        fetchDiscs();
    </script>
</body>
</html>